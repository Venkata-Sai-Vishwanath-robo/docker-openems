import{d as Z,j as $}from"./chunk-VQJOV6KK.js";import{b as fe}from"./chunk-AE767NUV.js";import{a as ce}from"./chunk-2OZBANFK.js";import{Ca as G,Da as b,E as N,Ea as A,F as S,Fc as H,Gd as Q,Hf as D,Qa as T,Ra as x,Sa as w,Ue as re,Uf as se,V as h,Ve as oe,Vf as le,Wc as M,Wf as ae,Xe as ne,Yc as P,Zc as z,a as v,ba as g,cb as V,cd as B,da as R,dc as q,dd as W,dg as ue,ee,fe as te,ge as ie,id as j,jb as _,jd as K,kb as k,kf as U,ld as Y,mg as de,nc as s,oa as I,qa as C,qd as X,sc as F,td as J,va as L,vc as c,wa as m,xa as p,ya as E}from"./chunk-UEHZAF3Y.js";import{a as y}from"./chunk-OQDXQ3X5.js";var me={de:{ALERTING:{DELAY:"Verz\xF6gerung",CHECKBOX_HELP:"Sie erhalten bei Eintritt des Ereignisses mit der ausgew\xE4hlten Verz\xF6gerung eine E-Mail.",FAULT:"Fehler",ONLINE_STATUS:"Online-Status",OTHER_USERS:"Weitere Benutzer"}},en:{ALERTING:{DELAY:"Delay",CHECKBOX_HELP:"When the event occurs, you will receive an e-mail after the set delay time.",FAULT:"Fault",ONLINE_STATUS:"Online-State",OTHER_USERS:"Other Users"}}};var pe=(()=>{class t extends U{static{this.METHOD="getUserAlertingConfigs"}constructor(e){super(t.METHOD,e),this.params=e}}return t})();var he=(()=>{class t extends U{static{this.METHOD="setUserAlertingConfigs"}constructor(e){super(t.METHOD,e),this.params=e}}return t})();var d;(function(t){function a(i,r){let n=null,u=i.controls;return r in u?(n=i.controls[r],n):(Object.values(u).map(f=>{f instanceof F&&(n=t.findFormControlSafely(f,r)),f instanceof c&&f.value instanceof F&&(n=t.findFormControlSafely(f.value,r))}),n)}t.findFormControlSafely=a;function e(i,r){let n=t.findFormControlSafely(i,r);return n?n.value:null}t.findFormControlsValueSafely=e;function o(i,r){return i.filter(n=>n?.props!=null&&r in n.props)}t.filterFieldPropsWithKey=o})(d||(d={}));var Ee=(t,a,e)=>[{key:"offline",props:{icon:{color:"danger",size:"large",name:"cloud-offline-outline",position:"end"},title:a.instant("ALERTING.ONLINE_STATUS")},fieldGroup:[{key:"offline-toggle",type:"toggle"},{key:"offline-delay-selection",type:"radio-buttons",name:a.instant("ALERTING.DELAY"),props:{options:t[l.OFFLINE],disabledOnFormControl:"offline-toggle"},validators:{validation:[s.required]}},{key:"offline-checkbox",type:"checkbox",name:"E-Mail",props:{help:a.instant("ALERTING.CHECKBOX_HELP"),disabledOnFormControl:"offline-toggle"},validators:[s.required]}]},...D.isAtLeast(e,D.INSTALLER)?[{key:"fault",props:{icon:{color:"danger",size:"large",name:"alert-circle-outline",position:"end"},title:a.instant("ALERTING.FAULT")},fieldGroup:[{key:"fault-toggle",type:"toggle"},{key:"fault-delay-selection",type:"radio-buttons",name:a.instant("EDGE.CONFIG.ALERTING.DELAY"),props:{options:t[l.OFFLINE],disabledOnFormControl:"fault-toggle"},validators:[s.required]},{key:"fault-checkbox",type:"checkbox",name:"E-Mail",props:{help:a.instant("ALERTING.CHECKBOX_HELP"),required:!0,disabledOnFormControl:"fault-toggle"},validators:{validation:[s.required]}}]}]:[]],Fe=(t,a,e)=>{function o(i,r){return{key:i.userLogin,fieldGroup:[...ge("offline",r.instant("ALERTING.ONLINE_STATUS"),a[l.OFFLINE],{color:"danger",name:"cloud-offline-outline"},r),...ge("fault",r.instant("ALERTING.FAULT"),a[l.FAULT],{color:"danger",name:"alert-circle-outline"},r)]}}return t.map(i=>o(i,e))},ge=(t,a,e,o,i)=>[{key:t+"-toggle",type:"toggle",name:a,props:{icon:y({color:"danger",size:"large",name:"help-circle-outline",position:"end"},o)},fieldGroup:[{key:t+"-delay-selection",type:"radio-buttons",name:i.instant("EDGE.CONFIG.ALERTING.DELAY"),props:{options:e,disabledOnFormControl:t+"-toggle"},expressions:{"props.disabled":r=>!r.model[t+"-toggle"]},validators:[s.required]},{key:t+"-checkbox",type:"checkbox",name:"E-Mail",props:{help:i.instant("ALERTING.CHECKBOX_HELP"),disabledOnFormControl:t+"-toggle"},validators:[s.requiredTrue]}]}];var Ie=()=>({});function Ce(t,a){if(t&1&&(m(0,"ion-row",8)(1,"ion-col",9)(2,"ion-card")(3,"ion-item",4),E(4,"ion-icon",10),m(5,"ion-label"),T(6),_(7,"translate"),p()(),m(8,"ion-card-content",11)(9,"form"),E(10,"formly-form",7),p()()()()()),t&2){let e=A(2);h(6),w(" ",k(7,5,"ALERTING.OTHER_USERS")," "),h(4),L("model",V(7,Ie))("fields",e.otherUserForm.fields)("options",e.otherUserForm.options)("form",e.otherUserForm.formGroup)}}function Le(t,a){if(t&1&&(m(0,"ion-grid",0)(1,"ion-row",2)(2,"ion-col",3)(3,"ion-card")(4,"ion-item",4),E(5,"ion-icon",5),m(6,"ion-label")(7,"span"),T(8),p()(),E(9,"oe-help-button",6),p(),m(10,"ion-card-content",0)(11,"form"),E(12,"formly-form",7),p()()()()(),I(13,Ce,11,8,"ion-row",8),p()),t&2){let e=A();h(8),x(e.user.name),h(4),L("model",e.currentUserForm.model)("fields",e.currentUserForm.fields)("options",e.currentUserForm.options)("form",e.currentUserForm.formGroup),h(),C(e.otherUserForm?13:-1)}}function Te(t,a){if(t&1&&E(0,"ngx-spinner",1),t&2){let e=A();L("name",e.spinnerId)}}function Ue(t,a){if(t&1){let e=G();m(0,"ion-footer")(1,"ion-grid")(2,"ion-row",2)(3,"ion-col",12)(4,"ion-button",13),b("click",function(){N(e);let i=A();return S(i.setUsersAlertingConfig())}),T(5," GENERAL.SAVE "),p()()()()()}}var l=(function(t){return t[t.OFFLINE=0]="OFFLINE",t[t.FAULT=1]="FAULT",t[t.WARNING=2]="WARNING",t})(l||{}),st=(()=>{class t{static{this.SELECTOR="alerting"}static{this.NO_ALERTING=0}constructor(e,o,i,r,n,u){this.route=e,this.utils=o,this.websocket=i,this.service=r,this.translate=n,this.formBuilder=u,this.spinnerId=t.SELECTOR,this.AlertingType=l,this.defaultValues={[l.OFFLINE]:this.asDelayOptions([15,60,1440]),[l.FAULT]:this.asDelayOptions([15,60,1440]),[l.WARNING]:this.asDelayOptions([15,60,1440])},this.subscriptions=new v,re.setAdditionalTranslationFile(me,n).then(({lang:f,translations:O,shouldMerge:ye})=>{n.setTranslation(f,O,ye)})}static isFormValid(e){let o=d.findFormControlsValueSafely(e,"fault-toggle"),i=d.findFormControlsValueSafely(e,"offline-toggle"),r=d.findFormControlSafely(e,"offline-checkbox");r.setValidators(s.requiredTrue),r.updateValueAndValidity();let n=d.findFormControlSafely(e,"fault-checkbox");n.setValidators(s.requiredTrue),n.updateValueAndValidity();let u=o&&n.invalid,f=i&&r.invalid;return!(u||f)}ngOnInit(){this.service.startSpinner(this.spinnerId),this.service.getCurrentEdge().then(e=>{this.edge=e,this.service.metadata.subscribe(i=>{this.user=i.user});let o=new pe({edgeId:this.edge.id});this.sendRequest(o).then(i=>{let r=i.result;this.setupCurrentUser(r.currentUserSettings),this.setupOtherUsers(r.otherUsersSettings),this.service.stopSpinner(this.spinnerId)}).catch(i=>{this.error=i.error})})}ngOnDestroy(){this.subscriptions.unsubscribe()}isValidDelay(e,o){return o<=0?!1:this.defaultValues[e].some(i=>i.value===o)}getLabelToDelay(e){return e<=0?this.translate.instant("EDGE.CONFIG.ALERTING.DEACTIVATED"):e>=1440?(e=e/1440,e+" "+(e==1?this.translate.instant("GENERAL.TIME.DAY"):this.translate.instant("GENERAL.TIME.DAYS"))):e>=60?(e=e/60,e+" "+(e==1?this.translate.instant("GENERAL.TIME.HOUR"):this.translate.instant("GENERAL.TIME.HOURS"))):e+" "+(e==1?this.translate.instant("GENERAL.TIME.MINUTE"):this.translate.instant("GENERAL.TIME.MINUTES"))}setUsersAlertingConfig(){let e=this.edge.id,o=[],i=[];if(this.currentUserForm.formGroup.dirty){let u=this.currentUserForm.formGroup;if(o.push(u),!t.isFormValid(u)){u.markAllAsTouched(),this.service.toast("Please check the mail option","warning");return}i.push(y({userLogin:this.currentUserInformation.userLogin},this.getDelays(u)))}let r=[];if(this.otherUserInformation&&this.otherUserForm.formGroup.dirty){o.push(this.otherUserForm.formGroup);for(let u of this.otherUserInformation){let f=this.otherUserForm.formGroup.controls[u.userLogin];if(f.pristine)continue;if(!t.isFormValid(f)){f.markAllAsTouched(),this.service.toast("Please check all required fields","warning");return}i.push(y({userLogin:u.userLogin},this.getDelays(f))),r.push(u)}}let n=new he({edgeId:e,userSettings:i});this.sendRequestAndUpdate(n,o)}isDirty(){return this.error||!this.currentUserForm?!1:this.currentUserForm?.formGroup?.dirty||this.otherUserForm.formGroup?.dirty}setupCurrentUser(e){this.currentUserInformation=this.asDetailedSettings(e),this.currentUserForm=this.generateForm(this.currentUserInformation,this.edge.role)}generateForm(e,o){let i=this.defaultValues[l.OFFLINE];return this.isValidDelay(l.OFFLINE,e.offlineEdgeDelay)||i.push({value:e.offlineEdgeDelay,label:this.getLabelToDelay(e.offlineEdgeDelay)}),{formGroup:new F({"offline-toggle":new c(e.isOfflineActive,s.required),"offline-delay-selection":new c(e.offlineEdgeDelay,s.required),"offline-checkbox":new c(e.isOfflineActive,s.requiredTrue),"fault-toggle":new c(e.isFaultActive,s.required),"fault-delay-selection":new c(e.faultEdgeDelay,s.required),"fault-checkbox":new c(e.isFaultActive,s.requiredTrue)}),options:{},model:{},fields:[{key:"currentUser",type:"input",templateOptions:{options:Ee(this.defaultValues,this.translate,o)},wrappers:["formly-current-user-alerting"]}]}}setupOtherUsers(e){if(!e||e.length===0)return;let o=new F({});this.otherUserInformation=[],oe.sortedAlphabetically(e,r=>r.userLogin).forEach(r=>{let n={userLogin:r.userLogin,offlineEdgeDelay:this.getValueOrDefault(r,l.OFFLINE),faultEdgeDelay:this.getValueOrDefault(r,l.FAULT),warningEdgeDelay:this.getValueOrDefault(r,l.WARNING)};this.otherUserInformation.push(n),o.addControl(n.userLogin,this.formBuilder.group({"offline-toggle":new c(r.offlineEdgeDelay>0,s.required),"offline-delay-selection":new c(n.offlineEdgeDelay,s.required),"offline-checkbox":new c(r.offlineEdgeDelay>0,s.requiredTrue),"fault-toggle":new c(r.faultEdgeDelay>0,s.required),"fault-delay-selection":new c(n.faultEdgeDelay,s.required),"fault-checkbox":new c(r.faultEdgeDelay>0,s.requiredTrue)}))}),this.otherUserForm={formGroup:o,options:{},model:{},fields:[{key:"otherUsers",type:"input",props:{options:Fe(e,this.defaultValues,this.translate)},wrappers:["formly-other-users-alerting"]}]}}getValue(e,o){switch(o){case l.OFFLINE:return e.offlineEdgeDelay;case l.FAULT:return e.faultEdgeDelay;case l.WARNING:return e.warningEdgeDelay}}getValueOrDefault(e,o){let i=this.getValue(e,o);return i<=0?this.defaultValues[o][0].value:i}asDetailedSettings(e){return{userLogin:e.userLogin,offlineEdgeDelay:this.getValueOrDefault(e,l.OFFLINE),warningEdgeDelay:this.getValueOrDefault(e,l.WARNING),faultEdgeDelay:this.getValueOrDefault(e,l.FAULT),isOfflineActive:e.offlineEdgeDelay>0,isFaultActive:e.faultEdgeDelay>0,isWarningActive:e.warningEdgeDelay>0}}asDelayOptions(e){return e.map(o=>this.asDelayOption(o))}asDelayOption(e){return{value:e,label:this.getLabelToDelay(e)}}sendRequestAndUpdate(e,o){this.sendRequest(e).then(()=>{this.service.toast(this.translate.instant("GENERAL.CHANGE_ACCEPTED"),"success");for(let i of o.values())i.markAsPristine()}).catch(i=>{let r=i.error;this.errorToast(this.translate.instant("GENERAL.CHANGE_FAILED"),r.message)})}sendRequest(e){return new Promise((o,i)=>{this.service.startSpinner(this.spinnerId),this.websocket.sendRequest(e).then(r=>{o(r)}).catch(r=>{let n=r.error;this.errorToast(this.translate.instant("EDGE.CONFIG.ALERTING.TOAST.ERROR"),n.message),i(r)}).finally(()=>{this.service.stopSpinner(this.spinnerId)})})}errorToast(e,o){this.service.toast("[ "+e+" ]<br/>"+o,"danger")}getDelays(e){let o=d.findFormControlsValueSafely(e,"offline-delay-selection"),i=d.findFormControlsValueSafely(e,"offline-toggle"),r=d.findFormControlsValueSafely(e,"fault-delay-selection"),n=d.findFormControlsValueSafely(e,"fault-toggle");return{offlineEdgeDelay:i?o:0,warningEdgeDelay:0,faultEdgeDelay:n?r:0}}static{this.\u0275fac=function(o){return new(o||t)(g(q),g(ne),g(ue),g(ae),g(ee),g(H))}}static{this.\u0275cmp=R({type:t,selectors:[["alerting"]],decls:4,vars:2,consts:[[1,"ion-no-padding"],[3,"name"],[1,"ion-justify-content-center"],["size","8","size-md","8","size-xs","12"],["lines","full","color","light"],["slot","start","name","person-outline","color","primary"],["key","SETTINGS_ALERTING"],[3,"model","fields","options","form"],[1,"ion-justify-content-center","ion-padding-top"],["size","10","size-md","10","size-xs","12"],["slot","start","name","people-outline","color","primary"],[1,"ion-no-padding-left-right"],["size","12","size-md","6"],["expand","block","type","submit","color","primary","translate","",3,"click"]],template:function(o,i){o&1&&(m(0,"ion-content"),I(1,Le,14,6,"ion-grid",0)(2,Te,1,1,"ngx-spinner",1),p(),I(3,Ue,6,0,"ion-footer")),o&2&&(h(),C(i.currentUserForm?1:2),h(2),C(!(i.currentUserForm==null||i.currentUserForm.formGroup==null)&&i.currentUserForm.formGroup.dirty||!(i.otherUserForm==null||i.otherUserForm.formGroup==null)&&i.otherUserForm.formGroup.dirty?3:-1))},dependencies:[de,M,P,z,B,W,j,K,Y,X,J,Q,te,ce,fe,le,se,$,Z,ie],styles:["ion-select[_ngcontent-%COMP%]{max-width:100%!important;margin:auto;padding:0;vertical-align:middle}"]})}}return t})();export{d as a,st as b};
