import{Lf as o,c as m,i as h,kf as a,oe as u,u as d}from"./chunk-UEHZAF3Y.js";var c=(()=>{class r extends a{static{this.METHOD="executeSystemUpdate"}constructor(s){super(r.METHOD,s),this.params=s}}return r})();var S=(()=>{class r extends a{static{this.METHOD="getSystemUpdateState"}constructor(){super(r.METHOD,{})}}return r})();var U=class{constructor(e,s){this.edge=e,this.websocket=s,this.canNotBeUpdated=!1,this.isEdgeRestarting=!1,this.systemUpdateState={unknown:{}},this.ngUnsubscribe=new m}start(){return new Promise((e,s)=>{this.update().then(t=>{if(t.running&&t.running?.percentCompleted!=100){e(t);return}this.stopRefreshSystemUpdateState(),e(t)}).catch(t=>{s(t)})})}executeSystemUpdate(){return this.systemUpdateState={running:{percentCompleted:0,logs:[]}},new Promise((e,s)=>{this.edge.sendRequest(this.websocket,new o({componentId:"_host",payload:new c({isDebug:u.debugMode})})).then(t=>{let n=t.result;this.setSystemUpdateState(n)}).catch(t=>{s(t)}),this.update().then(t=>{t.updated&&(this.stopRefreshSystemUpdateState(),e(this.systemUpdateState))}).catch(t=>{s(t)})})}stop(){this.stopRefreshSystemUpdateState(),this.ngUnsubscribe.complete()}refreshSystemUpdateState(){return new Promise((e,s)=>{this.edge.sendRequest(this.websocket,new o({componentId:"_host",payload:new S})).then(t=>{let n=t.result;this.setSystemUpdateState(n),n.updated&&this.stopRefreshSystemUpdateState(),e(this.systemUpdateState)}).catch(t=>{if(this.systemUpdateState.running){this.isEdgeRestarting=!0;return}s(t)})})}update(){return new Promise((e,s)=>{h(0,15e3).pipe(d(this.ngUnsubscribe)).subscribe(n=>{this.edge.isOnline&&this.refreshSystemUpdateState().then(i=>{e(i)}).catch(i=>{if(!i.error)return;let p=i.error.message;p&&p.includes("ExecuteSystemCommandRequest is not implemented for Windows")&&(this.canNotBeUpdated=!0,this.stopRefreshSystemUpdateState(),s(i))})})})}stopRefreshSystemUpdateState(){this.ngUnsubscribe.next()}setSystemUpdateState(e){this.systemUpdateState=e,this.systemUpdateStateChange(e)}};export{U as a};
