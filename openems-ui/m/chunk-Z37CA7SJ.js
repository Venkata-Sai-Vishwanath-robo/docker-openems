import{a as xe}from"./chunk-FMKZICNI.js";import{b as k,c as ye,f as ve,g as q,h as Ie}from"./chunk-A6D3LFCM.js";import"./chunk-VQJOV6KK.js";import{f as Ce}from"./chunk-GYAINRZU.js";import"./chunk-V6SQQYN5.js";import{$d as pe,Ac as Q,Ca as v,Da as _,E as g,Ea as l,F as y,Gd as oe,Hc as Z,If as me,Jf as ue,Kf as T,Lf as F,Qa as f,Qb as V,S as P,Sa as z,T as N,U as O,Uf as he,V as r,Vd as re,Wc as $,Wf as _e,Xe as de,Yc as ee,Zc as te,ba as d,c as D,cd as ie,da as U,db as M,dc as j,dd as ne,dg as fe,ee as ae,fc as H,fe as le,gc as B,jc as X,jd as se,kf as A,m as L,mf as R,mg as ge,oa as m,oe as ce,qa as u,qc as J,sc as W,u as b,va as h,wa as c,xa as a,ya as x,yc as Y,zb as G}from"./chunk-UEHZAF3Y.js";import"./chunk-TCWA4BEU.js";import"./chunk-HJTVDRW6.js";import"./chunk-YJIFWFWF.js";import"./chunk-QUJFQN2Y.js";import"./chunk-P3LHHAYW.js";import"./chunk-Y7WT5TFP.js";import"./chunk-JHMH7CMQ.js";import"./chunk-WVHTM5RI.js";import"./chunk-IN6HLDFE.js";import"./chunk-GIMG75PD.js";import"./chunk-IHO4TDRD.js";import"./chunk-4KCIDQZU.js";import"./chunk-7UI6JPU6.js";import"./chunk-J5AVGG2P.js";import"./chunk-VIYDSDQU.js";import"./chunk-F46NF3P5.js";import"./chunk-SAL3DLJT.js";import"./chunk-MTHZ7MWU.js";import"./chunk-WI5MSH4N.js";import"./chunk-EOGXKGKT.js";import"./chunk-CKP3SGE2.js";import"./chunk-RY6RMDSE.js";import{g as K}from"./chunk-OQDXQ3X5.js";var w;(function(t){t.METHOD="getApp";class p extends A{constructor(n){super(t.METHOD,{}),this.params=n}}t.Request=p;class e extends R{constructor(n,i){super(n,i),this.id=n,this.result=i}}t.Response=e})(w||(w={}));var I;(function(t){t.METHOD="getAppDescriptor";class p extends A{constructor(i){super(t.METHOD,i),this.params=i}}t.Request=p;class e extends R{constructor(i,o){super(i,o),this.id=i,this.result=o}}t.Response=e;function s(n,i){return n.websiteUrl&&(n.sanitizedWebsiteUrl=i.bypassSecurityTrustResourceUrl(n.websiteUrl)),n}t.postprocess=s})(I||(I={}));var we=t=>["../../update",t],Se=t=>({name:t});function Ee(t,p){if(t&1&&x(0,"img",6),t&2){let e=l(2);h("src",e.app.image,P)}}function be(t,p){if(t&1){let e=v();c(0,"img",10),_("error",function(){g(e);let n=l(3);return y(n.app.imageUrl=null)}),a()}if(t&2){let e=l(3);h("src",e.app.imageUrl,P)}}function Pe(t,p){if(t&1&&(c(0,"div",9)(1,"h1",11),f(2),a()()),t&2){let e=l(3);r(2),z(" ",e.app.name," ")}}function Me(t,p){if(t&1&&m(0,be,1,1,"img",6)(1,Pe,3,1,"div",9),t&2){let e=l(2);u(e.app.imageUrl?0:1)}}function Te(t,p){t&1&&(c(0,"div")(1,"ion-button",12),f(2,"EDGE.CONFIG.APP.BUY_APP"),a()())}function Fe(t,p){if(t&1){let e=v();c(0,"div")(1,"ion-button",13),_("click",function(){g(e);let n=l(2);return y(n.registerKey(n.app.appId))}),f(2," EDGE.CONFIG.APP.KEY.REGISTER_KEY"),a()()}}function ke(t,p){if(t&1){let e=v();c(0,"div")(1,"ion-button",14),_("click",function(){g(e);let n=l(2);return y(n.installApp(n.app.appId))}),f(2,"EDGE.CONFIG.APP.CREATE_APP "),a()()}if(t&2){let e=l(2);r(),h("disabled",e.app.cardinality!=="MULTIPLE"&&e.app.instanceIds.length!==0||e.app.status.name!=="INSTALLABLE"||!(e.canEnterKey||e.hasPredefinedKey))}}function qe(t,p){if(t&1&&(c(0,"ion-col",8),x(1,"iframe",15),a()),t&2){let e=l(2);r(),h("src",e.descriptor.sanitizedWebsiteUrl,N)("ngStyle",e.iFrameStyle())}}function Ke(t,p){if(t&1){let e=v();c(0,"ion-grid",0)(1,"ion-row",2)(2,"ion-col",3)(3,"form",4),_("ngSubmit",function(){g(e);let n=l();return y(n.submit())}),c(4,"ion-card")(5,"ion-card-content")(6,"div",5),m(7,Ee,1,1,"img",6)(8,Me,2,1),a(),m(9,Te,3,0,"div"),m(10,Fe,3,0,"div"),c(11,"div")(12,"ion-button",7),f(13," EDGE.CONFIG.APP.MODIFY_APP"),a()(),m(14,ke,3,1,"div"),a()()()(),m(15,qe,2,2,"ion-col",8),a()()}if(t&2){let e=l();r(3),h("formGroup",e.form),r(4),u(e.app.image?7:8),r(2),u(-1),r(),u(e.isPreInstalledApp||e.isFreeApp?-1:10),r(2),h("disabled",e.app.instanceIds.length===0)("routerLink",M(9,we,e.app.appId))("queryParams",M(11,Se,e.app.name)),r(2),u(e.isPreInstalledApp?-1:14),r(),u(e.descriptor!=null&&e.descriptor.websiteUrl?15:-1)}}var dt=(()=>{class t{static{this.SELECTOR="app-single"}constructor(e,s,n,i,o,C,S,E){this.route=e,this.router=s,this.utils=n,this.websocket=i,this.translate=o,this.service=C,this.sanitizer=S,this.modalController=E,this.spinnerId=t.SELECTOR,this.form=null,this.model=null,this.isFreeApp=!1,this.isPreInstalledApp=!1,this.appId=null,this.appName=null,this.app=null,this.descriptor=null,this.isXL=!0,this.requestCount=3,this.receivedResponse=0,this.edge=null,this.key=null,this.useMasterKey=!1,this.stopOnDestroy=new D}onResize(e){this.updateIsXL()}ngOnInit(){this.service.startSpinner(this.spinnerId),this.updateIsXL(),this.appId=this.route.snapshot.params.appId,this.appName=this.route.snapshot.queryParams.name;let e=this.appId;this.service.setCurrentComponent(this.appName,this.route).then(s=>{this.edge=s,this.edge.sendRequest(this.websocket,new k.Request({payload:new ye.Request({appId:this.appId})})).then(i=>{let o=i.result;this.isFreeApp=o.isAppFree}).catch(()=>{this.isFreeApp=!1}),T(this.edge)?this.edge.getConfig(this.websocket).pipe(L(i=>i!==null),b(this.stopOnDestroy)).subscribe(i=>{let C=i.getComponent("_appManager").properties.keyForFreeApps;C||this.increaseReceivedResponse(),this.keyForFreeApps!==C&&(this.keyForFreeApps=C,this.edge.sendRequest(this.websocket,new k.Request({payload:new xe.Request({key:this.keyForFreeApps})})).then(S=>{let E=S.result;this.isPreInstalledApp=E.bundles.some(Ae=>Ae.some(Re=>Re.appId==this.appId))}).finally(()=>{this.increaseReceivedResponse()}))}):(this.isPreInstalledApp=!1,this.increaseReceivedResponse()),this.service.metadata.pipe(b(this.stopOnDestroy)).subscribe(i=>{this.canEnterKey=me(s,i.user),this.hasPredefinedKey=ue(s,i.user)}),history?.state&&"app"in history.state?("app"in history.state&&this.setApp(history.state.app),"appKey"in history.state&&(this.key=history.state.appKey),"useMasterKey"in history.state&&(this.useMasterKey=history.state.useMasterKey)):s.sendRequest(this.websocket,new F({componentId:"_appManager",payload:new w.Request({appId:e})})).then(i=>{let o=i.result.app;o.imageUrl=ce.links.APP_CENTER.APP_IMAGE(this.translate.getCurrentLang(),o.appId),this.setApp(o)}).catch(i=>{console.error(i.error),this.service.toast("Error while receiving App["+e+"]: "+i.error.message,"danger")}),s.sendRequest(this.websocket,new F({componentId:"_appManager",payload:new I.Request({appId:e})})).then(i=>{let o=i.result;this.descriptor=I.postprocess(o,this.sanitizer)}).catch(Ie.errorToast(this.service,i=>"Error while receiving AppDescriptor for App["+e+"]: "+i)).finally(()=>{this.increaseReceivedResponse()})})}ngOnDestroy(){this.stopOnDestroy.next(),this.stopOnDestroy.complete()}iFrameStyle(){return{height:this.isXL?"100%":window.innerHeight+"px"}}installApp(e){if(this.key||this.useMasterKey){let s=this.useMasterKey?{useMasterKey:!0}:{appKey:this.key};this.router.navigate(["device/"+this.edge.id+"/settings/app/install/"+this.appId],{queryParams:{name:this.appName},state:s});return}if(!T(this.edge)||this.isFreeApp){this.router.navigate(["device/"+this.edge.id+"/settings/app/install/"+this.appId],{queryParams:{name:this.appName}});return}this.presentModal(e,q.NAVIGATE)}registerKey(e){this.presentModal(e,q.REGISTER)}updateIsXL(){this.isXL=1200<=window.innerWidth}setApp(e){this.app=e,this.form=new W({}),this.increaseReceivedResponse()}increaseReceivedResponse(){this.receivedResponse++,this.receivedResponse==this.requestCount&&(this.receivedResponse=0,this.service.stopSpinner(this.spinnerId))}presentModal(e,s){return K(this,null,function*(){return yield(yield this.modalController.create({component:ve,componentProps:{edge:this.edge,appId:e,behaviour:s,appName:this.appName},cssClass:"auto-height"})).present()})}static{this.\u0275fac=function(s){return new(s||t)(d(j),d(H),d(de),d(fe),d(ae),d(_e),d(V),d(pe))}}static{this.\u0275cmp=U({type:t,selectors:[["app-single"]],hostBindings:function(s,n){s&1&&_("resize",function(o){return n.onResize(o)},O)},decls:3,vars:2,consts:[[2,"height","100%"],[3,"name"],[1,"ion-justify-content-center",2,"height","100%"],["size","12","size-xl","3"],[3,"ngSubmit","formGroup"],[1,"ion-margin",2,"display","flex","align-items","center","justify-content","center"],[3,"src"],["translate","",2,"width","100%",3,"disabled","routerLink","queryParams"],["size","12","size-xl","7"],[2,"max-width","100%"],[3,"error","src"],[2,"text-align","center","white-space","initial"],["disabled","","translate","",2,"width","100%"],["translate","",2,"width","100%",3,"click"],["translate","",2,"width","100%",3,"click","disabled"],["name","appInfo","title","App-Info",2,"width","100%",3,"src","ngStyle"]],template:function(s,n){s&1&&(c(0,"ion-content",0),x(1,"ngx-spinner",1),m(2,Ke,16,13,"ion-grid",0),a()),s&2&&(r(),h("name",n.spinnerId),r(),u(n.form?2:-1))},dependencies:[ge,G,$,ee,te,ie,ne,se,oe,re,le,Ce,he,Z,Y,J,Q,X,B],encapsulation:2})}}return t})();export{dt as SingleAppComponent};
