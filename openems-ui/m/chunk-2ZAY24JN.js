import{d as Q,j as Z}from"./chunk-VQJOV6KK.js";import{c as pe}from"./chunk-NLFVUSHU.js";import{b as le}from"./chunk-AE767NUV.js";import{a as me}from"./chunk-2OZBANFK.js";import{f as de}from"./chunk-GYAINRZU.js";import"./chunk-V6SQQYN5.js";import{Ca as D,Da as S,E as p,Ea as g,F as u,Gc as F,Gd as $,Hc as q,Hf as oe,Lc as H,Lf as b,Pd as X,Qa as k,Sa as N,Sd as Y,V as d,Wc as B,Wf as re,Yc as W,Zc as K,ba as f,cd as V,da as T,dd as P,dg as ae,ee,fe as te,ge as ie,jb as A,jd as z,kb as C,kf as m,ld as J,mf as se,mg as ce,pf as ne,qc as x,qd as U,sa as O,sc as M,ta as _,td as j,ua as v,uc as G,va as h,wa as a,xa as l,ya as E,yc as L}from"./chunk-UEHZAF3Y.js";import"./chunk-TCWA4BEU.js";import"./chunk-HJTVDRW6.js";import"./chunk-YJIFWFWF.js";import"./chunk-QUJFQN2Y.js";import"./chunk-P3LHHAYW.js";import"./chunk-Y7WT5TFP.js";import"./chunk-JHMH7CMQ.js";import"./chunk-WVHTM5RI.js";import"./chunk-IN6HLDFE.js";import"./chunk-GIMG75PD.js";import"./chunk-IHO4TDRD.js";import"./chunk-4KCIDQZU.js";import"./chunk-7UI6JPU6.js";import"./chunk-J5AVGG2P.js";import"./chunk-VIYDSDQU.js";import"./chunk-F46NF3P5.js";import"./chunk-SAL3DLJT.js";import"./chunk-MTHZ7MWU.js";import"./chunk-WI5MSH4N.js";import"./chunk-EOGXKGKT.js";import"./chunk-CKP3SGE2.js";import"./chunk-RY6RMDSE.js";import{a as y,b as w,g as R}from"./chunk-OQDXQ3X5.js";var ue=(()=>{class n extends m{static{this.METHOD="getNetworkConfig"}constructor(){super(n.METHOD,{})}}return n})();var fe=(()=>{class n extends m{static{this.METHOD="getNetworkInfo"}constructor(){super(n.METHOD,{})}}return n})();var he=(()=>{class n extends se{constructor(e,i){super(e,i),this.id=e,this.result=i}static{this.EMPTY=e=>new n(e,{networkInterfaces:[],routes:[]})}}return n})();var Ee=(()=>{class n extends m{static{this.METHOD="setNetworkConfig"}constructor(e){super(n.METHOD,e),this.params=e}}return n})();var c;(function(n){function I(i){let t=[];for(let s=0;s<4;s++){let o=Math.min(i,8);t.push(256-Math.pow(2,8-o)),i-=o}return t.join(".")}n.getSubnetmaskAsString=I;function e(i){return i.split(".").map(Number).map(s=>(s>>>0).toString(2).padStart(8,"0")).join("").split("1").length-1}n.getCidrFromSubnetmask=e})(c||(c={}));function be(n,I){if(n&1){let e=D();a(0,"ion-col",1)(1,"ion-card")(2,"ion-item",2),E(3,"ion-icon",3),a(4,"ion-label"),k(5),l(),a(6,"ion-text",4),k(7,"EDGE.NETWORK.ADVANCED_MODE"),l(),a(8,"ion-toggle",5),S("keydown.enter",function(){let t=p(e).$implicit,s=g();return t.model.advancedMode=!t.model.advancedMode,u(s.hideOrShowFields(t))})("ionChange",function(){let t=p(e).$implicit,s=g();return t.model.advancedMode=!t.model.advancedMode,u(s.hideOrShowFields(t))}),l(),E(9,"oe-help-button",6),l(),a(10,"ion-card-content")(11,"form",7),S("ngSubmit",function(){let t=p(e).$implicit,s=g();return u(s.submit(t))}),E(12,"formly-form",8),a(13,"ion-item")(14,"ion-button",9),k(15),A(16,"translate"),l()()()()()()}if(n&2){let e=I.$implicit;d(5),N(" ",e.name==="eth0"?"LAN":e.name+" (INTERNAL)"),d(3),h("checked",e.model.advancedMode),d(4),h("form",e.formGroup)("fields",e.fields)("model",e.model),d(2),h("disabled",e.formGroup.pristine),d(),N(" ",C(16,7,"EDGE.NETWORK.SUBMIT")," ")}}var Xe=(()=>{class n{static{this.SELECTOR="network"}static{this.ETH_0="eth0"}static{this.STATIC_LABEL="static"}static{this.NO_LABEL=""}constructor(e,i,t){this.translate=e,this.service=i,this.websocket=t,this.edge=null,this.forms=[],this.ipRegex=/^(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}\/(?:3[0-2]|[0-2]?[0-9])$/}static getDynamicIpWithSubnetMask(e,i){let t=e.networkInterfaces.find(s=>s.hardwareInterface===i);if(t){let s=t.ips.find(o=>"dynamic"in o);if(s)return s.address+"/"+s.subnetmask}return null}ngOnInit(){this.initializeComponent()}submit(e){if(!e.formGroup.valid){this.service.toast(this.translate.instant("EDGE.NETWORK.MANDATORY_FIELDS"),"danger");return}let i=this.buildAddressJson(e),t=this.buildRequest(e,i),s=e.name===n.ETH_0?n.ETH_0:e.name;this.sendRequest(s,t)}hideOrShowFields(e){let i=e.fields.find(r=>r.key=="addressesList"),t=e.fields.find(r=>r.key=="linkLocalAddressing"),s=e.fields.find(r=>r.key=="metric"),o=e.model.advancedMode;i&&(i.hide=!o),t&&(t.hide=!o),s&&(s.hide=!o)}initializeComponent(){return R(this,null,function*(){try{if(this.edge=yield this.service.getCurrentEdge(),this.edge){let e=yield this.edge.sendRequest(this.websocket,new b({componentId:"_host",payload:new ue})),i=new fe,[t,s]=yield ne.handleOrElse(this.edge.sendRequest(this.websocket,new b({componentId:"_host",payload:i})),he.EMPTY(i.id));this.handleNetworkResponses(e,s)}}catch(e){this.service.toast(this.translate.instant("EDGE.NETWORK.ERROR_READING")+e?.error?.message,"danger")}})}handleNetworkResponses(e,i){let t=e.result;if(this.edge){let s=this.edge.roleIsAtLeast(oe.ADMIN);for(let o of Object.keys(t.interfaces))if(s||o===n.ETH_0){let r=n.getDynamicIpWithSubnetMask(i.result,o);this.generateInterface(o,t.interfaces[o],r)}}}buildAddressJson(e){let i=[];if(e.model.addressesList)for(let t of e.model.addressesList){if(!this.ipRegex.test(t))return this.service.toast(this.translate.instant("EDGE.NETWORK.VALID_ADDRESS_WARNING"),"danger"),[];let[s,o]=t.split("/"),r=c.getSubnetmaskAsString(Number.parseInt(o));i.push({label:n.NO_LABEL,address:s,subnetmask:r})}return i}buildRequest(e,i){let t={interfaces:{}};if(e.model.dhcp)e.model.gateway=null,e.model.dns=null,e.model.ip=null,e.model.subnetmask=null;else{let s=e.model.ip,o=e.model.subnetmask;s&&o&&i.push({label:n.STATIC_LABEL,address:s,subnetmask:o})}return t.interfaces[e.name]=w(y({},e.model),{addresses:i}),t}sendRequest(e,i){return R(this,null,function*(){try{yield this.edge?.sendRequest(this.websocket,new b({componentId:"_host",payload:new Ee(i)})),this.service.toast(this.translate.instant("EDGE.NETWORK.SUCCESS_UPDATE")+`[${e}].`,"success")}catch(t){this.service.toast(this.translate.instant("EDGE.NETWORK.ERROR_UPDATING")+`[${e}].`+t?.error?.message,"danger")}})}generateInterface(e,i,t){let s=[],o=w(y({},i),{dynamicIp:null});if(i.addresses)for(let r of i.addresses)if(r.label==n.STATIC_LABEL)o.ip=r.address,o.subnetmask=r.subnetmask;else{let ge=c.getCidrFromSubnetmask(r.subnetmask),ke=r.address.concat("/"+ge.toString());s.push(ke)}o.addressesList=s,o.dynamicIp=t,this.forms.push({name:e,fields:this.fillFields(s),formGroup:new M({}),model:o})}fillFields(e){return[{key:"dhcp",type:"help-popover-label-with-description-and-checkbox",defaultValue:!0,templateOptions:{label:this.translate.instant("EDGE.NETWORK.DHCP.ADDRESS")},expressions:{"props.description":t=>t.model.dynamicIp,"props.helpMsg":t=>t.model.dynamicIp?this.translate.instant("EDGE.NETWORK.DHCP.INFO"):null}},{hideExpression:"model.dhcp",key:"ip",type:"input",resetOnHide:!1,templateOptions:{label:this.translate.instant("EDGE.NETWORK.IP_ADDRESS"),placeholder:"z.B. 192.168.0.50",required:!0},validators:{validation:["ip"]}},{hideExpression:"model.dhcp",key:"subnetmask",type:"input",resetOnHide:!1,templateOptions:{label:this.translate.instant("EDGE.NETWORK.SUBNETMASK"),placeholder:"z.B. 255.255.255.0",required:!0},validators:{validation:["subnetmask"]}},{hideExpression:"model.dhcp",key:"gateway",type:"input",resetOnHide:!1,templateOptions:{label:"Gateway",placeholder:"z.B. 192.168.0.1",required:!0},validators:{validation:["ip"]}},{hideExpression:"model.dhcp",key:"dns",type:"input",resetOnHide:!1,templateOptions:{label:"DNS-Server",placeholder:"z.B. 192.168.0.1",required:!0},validators:{validation:["ip"]}},{key:"linkLocalAddressing",type:"checkbox",resetOnHide:!1,templateOptions:{label:"Link-Local Address (z. B. 169.254.XXX.XXX)"},hide:!0},{hide:!0,key:"addressesList",type:"repeat",resetOnHide:!1,defaultValue:e,templateOptions:{label:this.translate.instant("EDGE.NETWORK.ADD_IP")},fieldArray:{type:"input",resetOnHide:!1}},{hide:!0,key:"metric",type:"input",resetOnHide:!1,templateOptions:{label:"Metric",placeholder:"z.B. 512, 1024 ..."},defaultValue:1024,parsers:[Number]}]}static{this.\u0275fac=function(i){return new(i||n)(f(ee),f(re),f(ae))}}static{this.\u0275cmp=T({type:n,selectors:[["network"]],decls:5,vars:0,consts:[[1,"ion-justify-content-center"],["size","12","size-xl","6"],["lines","full","color","light"],["size","large","slot","start","name","globe-outline","color","primary"],["translate",""],["button","","tabindex","0","mode","md","slot","end",3,"keydown.enter","ionChange","checked"],["slot","end","key","SETTINGS_NETWORK_CONFIGURATION"],[3,"ngSubmit"],[3,"form","fields","model"],["type","submit","color","primary",3,"disabled"]],template:function(i,t){i&1&&(a(0,"ion-content")(1,"ion-grid")(2,"ion-row",0),_(3,be,17,9,"ion-col",1,O),l()()()),i&2&&(d(3),v(t.forms))},dependencies:[ce,B,W,K,V,P,z,J,U,j,$,X,Y,H,te,pe,me,de,F,L,x,G,Z,Q,q,le,ie],encapsulation:2})}}return n})();export{Xe as NetworkComponent};
