import{a as Fe}from"./chunk-QYR44BZ5.js";import{a as ke,c as Ge,y as oe}from"./chunk-AHZPXDMV.js";import{a as Be}from"./chunk-3K6WAZNX.js";import{c as Pe}from"./chunk-NLFVUSHU.js";import"./chunk-AE767NUV.js";import"./chunk-U4AVYC7D.js";import"./chunk-RQWSIHDL.js";import"./chunk-6SDHATKH.js";import{f as Le}from"./chunk-GYAINRZU.js";import"./chunk-V6SQQYN5.js";import{Aa as z,Bb as ye,Ca as b,Da as w,E as I,Ea as r,F as g,Gc as Re,Gd as G,Hf as De,Lf as N,Qa as c,Ra as C,Sa as E,Ta as Te,Uf as F,V as o,W as Se,Wc as D,Wf as Y,Xe as Me,Ya as Ee,Yc as Ae,Zc as be,Zd as te,a as ce,ba as x,bg as Oe,c as le,cb as xe,cd as O,d as de,da as M,db as X,dd as we,dg as V,ee as ie,ge as P,gg as re,i as pe,ia as A,jb as p,jd as Z,kb as _,kf as U,lb as K,ld as ee,lg as ne,mf as B,mg as q,oa as m,oe as f,qa as S,qb as fe,qd as L,r as _e,ra as ue,rd as Ue,sa as Ce,ta as j,td as k,u as me,ua as $,va as T,vb as he,wa as s,wb as Ie,xa as l,xb as ge,ya as u,yb as ve,yd as Ne,za as J}from"./chunk-UEHZAF3Y.js";import"./chunk-TCWA4BEU.js";import"./chunk-HJTVDRW6.js";import"./chunk-YJIFWFWF.js";import"./chunk-QUJFQN2Y.js";import"./chunk-P3LHHAYW.js";import"./chunk-Y7WT5TFP.js";import"./chunk-JHMH7CMQ.js";import"./chunk-WVHTM5RI.js";import"./chunk-IN6HLDFE.js";import"./chunk-GIMG75PD.js";import"./chunk-IHO4TDRD.js";import"./chunk-4KCIDQZU.js";import"./chunk-7UI6JPU6.js";import"./chunk-J5AVGG2P.js";import"./chunk-VIYDSDQU.js";import"./chunk-F46NF3P5.js";import"./chunk-SAL3DLJT.js";import"./chunk-MTHZ7MWU.js";import"./chunk-WI5MSH4N.js";import"./chunk-EOGXKGKT.js";import"./chunk-CKP3SGE2.js";import"./chunk-RY6RMDSE.js";import{g as W}from"./chunk-OQDXQ3X5.js";var ae;(function(e){e.METHOD="executeUpdate";class a extends U{constructor(n){super(e.METHOD,n),this.params=n}}e.Request=a;class t extends B{constructor(n,d){super(n,d),this.id=n,this.result=d}}e.Response=t})(ae||(ae={}));var se;(function(e){e.METHOD="getUpdateables";class a extends U{constructor(){super(e.METHOD,{})}}e.Request=a;class t extends B{constructor(n,d){super(n,d),this.id=n,this.result=d}}e.Response=t})(se||(se={}));var Q;(function(e){e.METHOD="getUpdateState";class a extends U{constructor(n){super(e.METHOD,n),this.params=n}}e.Request=a;class t extends B{constructor(n,d){super(n,d),this.id=n,this.result=d}}e.Response=t})(Q||(Q={}));var Ye=(()=>{class e extends U{static{this.METHOD="executeSystemRestart"}constructor(t){super(e.METHOD,t),this.params=t}}return e})(),H=(function(e){return e.SOFT="SOFT",e.HARD="HARD",e})(H||{});var Je=e=>({edgeShortName:e}),ze=()=>({name:"hammer-outline",color:"primary",size:"medium"});function Xe(e,a){if(e&1&&(s(0,"ion-row")(1,"ion-col")(2,"ion-label"),c(3),l()()()),e&2){let t=r().$implicit;o(3),E(" ",t.info," ")}}function Ke(e,a){if(e&1&&(s(0,"ion-col")(1,"ion-label",5),c(2),l()()),e&2){let t=r().$implicit;o(),T("color",Ee(t.color)),o(),E(" ",t.message," ")}}function Qe(e,a){if(e&1&&(s(0,"div",8),u(1,"ngx-spinner",9),l()),e&2){let t=r(3).$implicit,i=r(2);o(),T("name",i.spinnerId+t.key)}}function Ze(e,a){if(e&1&&(J(0),A(1,Qe,2,1,"div",7),z()),e&2){let t=r(4);o(),T("ngSwitchCase",t.SystemRestartState.RESTARTING)}}function et(e,a){if(e&1&&(J(0),s(1,"ion-col"),J(2,6),p(3,"async"),A(4,Ze,2,1,"ng-container",3),p(5,"async"),z(),l(),z()),e&2){let t,i,n=r().$implicit,d=r(2);o(2),T("ngSwitch",(t=_(3,2,d.systemRestartState))==null?null:t.state),o(2),T("ngIf",((i=_(5,4,d.systemRestartState))==null?null:i.key)===n.key)}}function tt(e,a){if(e&1){let t=b();s(0,"ion-col")(1,"ion-item",10)(2,"ion-button",11),w("click",function(){I(t);let n=r().$implicit;return g(n.button.callback())}),c(3),l()()()}if(e&2){let t=r().$implicit;o(3),C(t.button.label)}}function it(e,a){if(e&1&&(J(0),A(1,Xe,4,1,"ion-row",3),s(2,"ion-row",4),A(3,Ke,3,3,"ion-col",3)(4,et,6,6,"ng-container",3),p(5,"async"),A(6,tt,4,1,"ion-col",3),l(),z()),e&2){let t,i=a.$implicit,n=r(2);o(),T("ngIf",i.info),o(2),T("ngIf",i.message),o(),T("ngIf",((t=_(5,4,n.systemRestartState))==null?null:t.state)!==n.SystemRestartState.INITIAL),o(2),T("ngIf",!i.button.disabled)}}function nt(e,a){if(e&1&&(s(0,"oe-flat-widget",1),p(1,"translate"),A(2,it,7,6,"ng-container",2),l()),e&2){let t=r();T("title",K(1,3,"SETTINGS.SYSTEM_UPDATE.EMS_RESTARTING",X(6,Je,t.environment.edgeShortName)))("icon",xe(8,ze)),o(2),T("ngForOf",t.options)}}var v=(function(e){return e[e.INITIAL=0]="INITIAL",e[e.RESTARTING=1]="RESTARTING",e[e.RESTARTED=2]="RESTARTED",e[e.FAILED=3]="FAILED",e})(v||{}),je=(()=>{class e{static{this.SELECTOR="oe-maintenance"}static{this.TIMEOUT=3e3}constructor(t,i,n,d){this.websocket=t,this.service=i,this.translate=n,this.alertCtrl=d,this.environment=f,this.edge=null,this.options=[{key:H.HARD,message:null,color:null,info:this.translate.instant("SETTINGS.SYSTEM_UPDATE.RESTART_WARNING",{system:f.edgeShortName}),roleIsAtLeast:De.OWNER,button:{callback:()=>this.confirmationAlert(H.HARD),disabled:!1,label:this.translate.instant("SETTINGS.SYSTEM_UPDATE.EMS_RESTARTING",{edgeShortName:f.edgeShortName})}}],this.systemRestartState=new de({key:null,state:v.INITIAL}),this.spinnerId=e.SELECTOR,this.SystemRestartState=v,this.confirmationAlert=h=>ne(this.alertCtrl,this.translate,{message:this.translate.instant("SETTINGS.SYSTEM_UPDATE.RESTART_WARNING",{system:f.edgeShortName}),subHeader:this.translate.instant("SETTINGS.SYSTEM_UPDATE.RESTART_CONFIRMATION",{system:f.edgeShortName}),buttons:[{text:this.translate.instant("GENERAL.RESTART"),handler:()=>this.execRestart(h)}]})}presentAlert(t){return W(this,null,function*(){let i=this.translate,n=t===H.HARD?f.edgeShortName:"OpenEMS";(yield this.alertCtrl.create({subHeader:i.instant("SETTINGS.SYSTEM_UPDATE.RESTART_CONFIRMATION",{system:n}),message:i.instant("SETTINGS.SYSTEM_UPDATE.RESTART_WARNING",{system:n}),buttons:[{text:i.instant("GENERAL.CANCEL"),role:"cancel"},{text:i.instant("GENERAL.RESTART"),handler:()=>this.execRestart(t)}],cssClass:"alertController"})).present()})}ngOnInit(){this.service.startSpinner(this.spinnerId),this.service.getCurrentEdge().then(t=>{this.service.getConfig().then(()=>{this.edge=t,this.options=this.options.map(i=>(i.button.disabled=!this.edge.roleIsAtLeast(i.roleIsAtLeast),i))})}),this.systemRestartState.subscribe(t=>{this.updateOptions(t.key)})}updateOptions(t){let i=null,n=!1,d=!1,h=null,y=t===H.HARD?f.edgeShortName:this.translate.instant("GENERAL.SYSTEM");switch(this.systemRestartState?.value?.state){case v.FAILED:i=this.translate.instant("SETTINGS.SYSTEM_UPDATE.RESTART_FAILED",{system:y}),h="warning",n=!1,d=!0;break;case v.RESTARTING:this.service.startSpinnerTransparentBackground(this.spinnerId+t),this.checkSystemState(t),n=!0,i=this.translate.instant("SETTINGS.SYSTEM_UPDATE.RESTARTING",{system:y,minutes:10});break;case v.RESTARTED:this.service.stopSpinner(this.spinnerId+t),n=!1,h="success",i=this.translate.instant("SETTINGS.SYSTEM_UPDATE.RESTARTED",{system:y}),d=!0;break;default:break}i&&(this.options=this.options.map(R=>(R.key===t&&(R.message=i),R.button.disabled=n||!this.edge.roleIsAtLeast(R.roleIsAtLeast),R.color=h,R.info=d?this.translate.instant("SETTINGS.SYSTEM_UPDATE.RESTART_WARNING",{system:f.edgeShortName}):null,R)))}execRestart(t){let i=new N({componentId:"_host",payload:new Ye({type:t})});this.edge.sendRequest(this.websocket,i).catch(()=>{this.systemRestartState.next({key:t,state:v.FAILED})}),setTimeout(()=>{this.systemRestartState?.value?.state!==v.FAILED&&this.systemRestartState.next({key:t,state:v.RESTARTING})},e.TIMEOUT)}checkSystemState(t){let i=new ce;i.add(this.edge.getConfig(this.websocket).pipe(_e(1)).subscribe(()=>{i.unsubscribe(),this.systemRestartState.next({key:t,state:v.RESTARTED})}))}static{this.\u0275fac=function(i){return new(i||e)(x(V),x(Y),x(ie),x(te))}}static{this.\u0275cmp=M({type:e,selectors:[["oe-maintenance"]],decls:1,vars:1,consts:[["class","ion-padding-top",3,"title","icon",4,"ngIf"],[1,"ion-padding-top",3,"title","icon"],[4,"ngFor","ngForOf"],[4,"ngIf"],[1,"ion-justify-content-end"],[3,"color"],[3,"ngSwitch"],["style","height: 3vh",4,"ngSwitchCase"],[2,"height","3vh"],[3,"name"],["lines","none",1,"ion-float-right",2,"justify-content","end"],[3,"click"]],template:function(i,n){i&1&&A(0,nt,3,9,"oe-flat-widget",0),i&2&&T("ngIf",n.edge)},dependencies:[q,he,Ie,ge,ve,D,O,L,k,G,F,oe,ke,ye,P],styles:["[_nghost-%COMP%]   :is(ion-card[_ngcontent-%COMP%]){cursor:auto!important}"]})}}return e})();var ot=e=>({edge:e}),at=e=>({edgeShortName:e});function st(e,a){if(e&1&&(s(0,"ion-item",0)(1,"ion-label"),c(2),p(3,"translate"),u(4,"br"),c(5),p(6,"translate"),l()(),s(7,"ion-item",0),u(8,"ion-progress-bar",1),l()),e&2){let t=r(3);o(2),C(K(3,2,"SETTINGS.SYSTEM_UPDATE.EDGE_RESTARTING",X(7,ot,t.environment.edgeShortName))),o(3),E(" ",_(6,5,"SETTINGS.SYSTEM_UPDATE.UPDATE_TIME"))}}function lt(e,a){if(e&1&&(s(0,"ion-item",0)(1,"ion-label"),c(2),p(3,"translate"),l()()),e&2){let t=r(3);o(2),E("",K(3,1,"SETTINGS.SYSTEM_UPDATE.OFFLINE",X(4,at,t.environment.edgeShortName))," ")}}function rt(e,a){if(e&1&&m(0,st,9,9)(1,lt,4,6,"ion-item",0),e&2){let t=r(2);S(t.executeUpdate.isEdgeRestarting?0:1)}}function ct(e,a){e&1&&(s(0,"ion-item",5)(1,"ion-label"),c(2),p(3,"translate"),l()()),e&2&&(o(2),C(_(3,1,"SETTINGS.SYSTEM_UPDATE.UPDATE_SEARCH")))}function dt(e,a){e&1&&(s(0,"ion-item",5)(1,"ion-label"),c(2),p(3,"translate"),l()()),e&2&&(o(2),E("",_(3,1,"SETTINGS.SYSTEM_UPDATE.UPDATE_NOT_POSSIBLE")," "))}function pt(e,a){if(e&1&&m(0,ct,4,3,"ion-item",5)(1,dt,4,3,"ion-item",5),e&2){let t=r(5);S(t.executeUpdate.canNotBeUpdated?1:0)}}function _t(e,a){e&1&&(s(0,"ion-item",5)(1,"ion-label"),c(2),p(3,"translate"),u(4,"br"),c(5),p(6,"translate"),l()(),s(7,"ion-item",5),u(8,"oe-flat-widget-percentagebar",6),l()),e&2&&(o(2),C(_(3,3,"SETTINGS.SYSTEM_UPDATE.UPDATE_PROGRESS")),o(3),E("",_(6,5,"SETTINGS.SYSTEM_UPDATE.UPDATE_TIME")," "),o(3),T("value",a.percentCompleted))}function mt(e,a){e&1&&u(0,"ion-icon",8)}function St(e,a){e&1&&u(0,"ion-icon",9)}function ut(e,a){if(e&1&&(s(0,"small"),c(1),l(),u(2,"br")),e&2){let t=a.$implicit;o(),C(t)}}function Ct(e,a){if(e&1&&(s(0,"p"),j(1,ut,3,1,null,null,Ce),l()),e&2){let t=r(2);o(),$(t.logs)}}function Tt(e,a){if(e&1){let t=b();s(0,"div")(1,"p",7),w("keydown.enter",function(){I(t);let n=r(6);return g(n.showLog=!n.showLog)})("click",function(){I(t);let n=r(6);return g(n.showLog=!n.showLog)}),m(2,mt,1,0,"ion-icon",8),m(3,St,1,0,"ion-icon",9),s(4,"span"),c(5,"\xA0Details"),l()(),m(6,Ct,3,0,"p"),l()}if(e&2){let t=r(6);o(2),S(t.showLog?-1:2),o(),S(t.showLog?3:-1),o(3),S(t.showLog?6:-1)}}function Et(e,a){e&1&&m(0,Tt,7,3,"div"),e&2&&S(a.logs.length>0?0:-1)}function xt(e,a){if(e&1&&(s(0,"ion-grid")(1,"ion-row")(2,"ion-col",2),m(3,pt,2,1),m(4,_t,9,7),l(),s(5,"ion-col")(6,"div",3),u(7,"ngx-spinner",4),l()()()(),m(8,Et,1,1)),e&2){let t,i,n=r(),d=r(3);o(3),S(n.unknown?3:-1),o(),S((t=n.running)?4:-1,t),o(3),T("name",d.spinnerId),o(),S((i=d.environment.debugMode&&n.running)?8:-1,i)}}function ft(e,a){e&1&&(s(0,"ion-grid")(1,"ion-row")(2,"ion-col")(3,"ion-item",5)(4,"ion-label"),c(5),p(6,"translate"),l()()(),s(7,"ion-col")(8,"ion-item",5)(9,"ion-label"),c(10),l()()()(),s(11,"ion-row")(12,"ion-col",10)(13,"ion-item",5)(14,"ion-label",11),c(15),p(16,"translate"),l()()()()()),e&2&&(o(5),C(_(6,3,"SETTINGS.SYSTEM_UPDATE.INSTALLED_VERSION")),o(5),C(a.version),o(5),E(" ",_(16,5,"SETTINGS.SYSTEM_UPDATE.LATEST_VERISON")," "))}function ht(e,a){if(e&1){let t=b();s(0,"ion-grid")(1,"ion-row")(2,"ion-col")(3,"ion-item",5)(4,"ion-label"),c(5),p(6,"translate"),l()()(),s(7,"ion-col")(8,"ion-item",5)(9,"ion-label"),c(10),l()()()(),s(11,"ion-row")(12,"ion-col")(13,"ion-item",5)(14,"ion-label"),c(15),p(16,"translate"),l()()(),s(17,"ion-col")(18,"ion-item",5)(19,"ion-label"),c(20),l()()()(),s(21,"ion-row"),u(22,"ion-col"),s(23,"ion-col")(24,"ion-item",12)(25,"ion-button",13),w("click",function(){I(t);let n=r(5);return g(n.confirmationAlert())}),c(26),p(27,"translate"),l()()()()()}if(e&2){let t=a;o(5),C(_(6,5,"SETTINGS.SYSTEM_UPDATE.INSTALLED_VERSION")),o(5),C(t.currentVersion),o(5),C(_(16,7,"SETTINGS.SYSTEM_UPDATE.NEW_VERSION")),o(5),C(t.latestVersion),o(6),E("",_(27,9,"SETTINGS.SYSTEM_UPDATE.NEW_VERSION_INSTALLING")," ")}}function It(e,a){if(e&1&&(m(0,ft,17,7,"ion-grid"),m(1,ht,28,11,"ion-grid")),e&2){let t,i,n=r();S((t=n.updated)?0:-1,t),o(),S((i=n.available)?1:-1,i)}}function gt(e,a){if(e&1&&m(0,xt,9,4)(1,It,2,2),e&2){let t=r(3);S(t.isWaiting?0:1)}}function vt(e,a){if(e&1&&m(0,gt,2,1),e&2){let t,i=r(2);S((t=i.executeUpdate==null?null:i.executeUpdate.systemUpdateState)?0:-1,t)}}function yt(e,a){if(e&1&&m(0,rt,2,1)(1,vt,1,1),e&2){let t=r();S(t.edge.isOnline?1:0)}}var $e=(()=>{class e{static{this.SELECTOR="oe-system-update"}constructor(t,i,n,d){this.websocket=t,this.service=i,this.alertCtrl=n,this.translate=d,this.stateChanged=new Se,this.executeUpdateInstantly=!1,this.environment=f,this.spinnerId=e.SELECTOR,this.executeUpdate=null,this.confirmationAlert=()=>ne(this.alertCtrl,this.translate,{message:this.translate.instant("SETTINGS.SYSTEM_UPDATE.WARNING",{system:f.edgeShortName}),subHeader:this.translate.instant("SETTINGS.SYSTEM_UPDATE.SUB_HEADER"),buttons:[{text:this.translate.instant("SETTINGS.SYSTEM_UPDATE.UPDATE_EXECUTE"),handler:()=>this.executeSystemUpdate()}]})}ngOnInit(){this.executeUpdate=new Fe(this.edge,this.websocket),this.executeUpdate.systemUpdateStateChange=t=>{this.stateChanged.emit(t),t.updated&&(this.service.stopSpinner(this.spinnerId),this.isWaiting=!1)},this.service.startSpinnerTransparentBackground(this.spinnerId),this.isWaiting=!0,this.executeUpdate.start().finally(()=>{this.executeUpdate.systemUpdateState.running||(this.service.stopSpinner(this.spinnerId),this.isWaiting=!1),this.executeUpdate.systemUpdateState.available&&this.executeUpdateInstantly&&this.executeSystemUpdate()})}ngOnDestroy(){this.executeUpdate.stop()}executeSystemUpdate(){this.service.startSpinnerTransparentBackground(this.spinnerId),this.isWaiting=!0,this.executeUpdate.executeSystemUpdate()}static{this.\u0275fac=function(i){return new(i||e)(x(V),x(Y),x(te),x(ie))}}static{this.\u0275cmp=M({type:e,selectors:[["oe-system-update"]],inputs:{executeUpdateInstantly:"executeUpdateInstantly",edge:"edge"},outputs:{stateChanged:"stateChanged"},decls:1,vars:1,consts:[["lines","none","color","light"],["type","indeterminate",2,"margin-top","1%"],["size","8"],[2,"height","3vh"],[3,"name"],["lines","none"],[3,"value"],[2,"cursor","pointer",3,"keydown.enter","click"],["name","arrow-down-circle-outline"],["name","arrow-up-circle-outline"],["size","12"],["color","success",1,"ion-text-wrap"],["lines","none",1,"ion-float-right"],[3,"click"]],template:function(i,n){i&1&&m(0,yt,2,1),i&2&&S(n.edge?0:-1)},dependencies:[q,D,O,Z,ee,L,k,Ne,G,Le,F,Re,P],encapsulation:2})}}return e})();var Rt=(e,a)=>a.updateable.id;function At(e,a){e&1&&(s(0,"ion-col",1),u(1,"oe-maintenance"),l())}function bt(e,a){if(e&1&&(s(0,"span"),c(1),p(2,"translate"),l()),e&2){let t=r(2);o(),Te(" ",_(2,2,"GENERAL.FOR")," ",t.edge.id)}}function wt(e,a){if(e&1&&(s(0,"ion-item",3),u(1,"ion-icon",4),s(2,"ion-label")(3,"span"),c(4),p(5,"translate"),l(),m(6,bt,3,4,"span"),l()(),s(7,"ion-card-content"),u(8,"oe-system-update",5),l()),e&2){let t=r();o(4),C(_(5,3,"EDGE.INDEX.SYSTEMUPDATE")),o(2),S(t.environment.backend==="OpenEMS Backend"?6:-1),o(2),T("edge",t.edge)}}function Ut(e,a){e&1&&(s(0,"ion-item",6)(1,"ion-label"),c(2),p(3,"translate"),l()()),e&2&&(o(2),C(_(3,1,"SETTINGS.SYSTEM_UPDATE.UPDATE_SEARCH")))}function Nt(e,a){if(e&1&&(s(0,"ion-grid")(1,"ion-row")(2,"ion-col")(3,"ion-item",6)(4,"ion-label"),c(5),p(6,"translate"),l()()(),s(7,"ion-col")(8,"ion-item",6)(9,"ion-label"),c(10),l()()()(),s(11,"ion-row")(12,"ion-col",7)(13,"ion-item",6)(14,"ion-label",8),c(15),p(16,"translate"),l()()()()()),e&2){let t=r().$implicit;o(5),C(_(6,3,"SETTINGS.SYSTEM_UPDATE.INSTALLED_VERSION")),o(5),C(t.updateState.version),o(5),E(" ",_(16,5,"SETTINGS.SYSTEM_UPDATE.LATEST_VERISON")," ")}}function Mt(e,a){if(e&1){let t=b();s(0,"ion-grid")(1,"ion-row")(2,"ion-col")(3,"ion-item",6)(4,"ion-label"),c(5),p(6,"translate"),l()()(),s(7,"ion-col")(8,"ion-item",6)(9,"ion-label"),c(10),l()()()(),s(11,"ion-row")(12,"ion-col")(13,"ion-item",6)(14,"ion-label"),c(15),p(16,"translate"),l()()(),s(17,"ion-col")(18,"ion-item",6)(19,"ion-label"),c(20),l()()()(),s(21,"ion-row"),u(22,"ion-col"),s(23,"ion-col")(24,"ion-item",9)(25,"ion-button",10),w("click",function(){I(t);let n=r().$implicit,d=r(2);return g(d.executeUpdate(n))}),c(26),p(27,"translate"),l()()()()()}if(e&2){let t=r().$implicit;o(5),C(_(6,5,"SETTINGS.SYSTEM_UPDATE.INSTALLED_VERSION")),o(5),C(t.updateState.currentVersion),o(5),C(_(16,7,"SETTINGS.SYSTEM_UPDATE.NEW_VERSION")),o(5),C(t.updateState.latestVersion),o(6),E(" ",_(27,9,"SETTINGS.SYSTEM_UPDATE.NEW_VERSION_INSTALLING")," ")}}function Dt(e,a){e&1&&u(0,"ion-icon",13)}function Ot(e,a){e&1&&u(0,"ion-icon",14)}function Lt(e,a){if(e&1&&(s(0,"small"),c(1),l(),u(2,"br")),e&2){let t=a.$implicit;o(),C(t)}}function kt(e,a){if(e&1&&j(0,Lt,3,1,null,null,ue),e&2){let t=r(3).$implicit;$(t.updateState.logs)}}function Gt(e,a){if(e&1){let t=b();s(0,"div")(1,"p",12),w("keydown.enter",function(){I(t);let n=r(4);return g(n.showLog=!n.showLog)})("click",function(){I(t);let n=r(4);return g(n.showLog=!n.showLog)}),m(2,Dt,1,0,"ion-icon",13),m(3,Ot,1,0,"ion-icon",14),s(4,"span"),c(5,"\xA0Details"),l()(),m(6,kt,2,0),l()}if(e&2){let t=r(4);o(2),S(t.showLog?-1:2),o(),S(t.showLog?3:-1),o(3),S(t.showLog?6:-1)}}function Pt(e,a){if(e&1&&(s(0,"ion-item",6)(1,"ion-label"),c(2),p(3,"translate"),u(4,"br"),c(5),p(6,"translate"),l()(),s(7,"ion-item",6),u(8,"oe-flat-widget-percentagebar",11),l(),m(9,Gt,7,3,"div")),e&2){let t=r().$implicit,i=r(2);o(2),E(" ",_(3,4,"SETTINGS.SYSTEM_UPDATE.UPDATE_PROGRESS")," "),o(3),E(" ",_(6,6,"SETTINGS.SYSTEM_UPDATE.UPDATE_TIME")," "),o(3),T("value",t.updateState.percentCompleted),o(),S(i.environment.debugMode&&t.updateState.logs.length>0?9:-1)}}function Bt(e,a){if(e&1&&(s(0,"ion-card")(1,"ion-item",3)(2,"ion-label"),c(3),l()(),s(4,"ion-card-content"),c(5),m(6,Ut,4,3,"ion-item",6)(7,Nt,17,7,"ion-grid")(8,Mt,28,11,"ion-grid")(9,Pt,10,8),l()()),e&2){let t,i=a.$implicit;o(3),E(" ",i.updateable.name," "),o(2),E(" ",i.updateable.description," "),o(),S((t=i.updateState==null?null:i.updateState.type)==="unknown"?6:t==="updated"?7:t==="available"?8:t==="running"?9:-1)}}function Ft(e,a){if(e&1&&(s(0,"ion-item-divider")(1,"ion-label"),c(2),p(3,"translate"),l()(),j(4,Bt,10,3,"ion-card",null,Rt)),e&2){let t=r();o(2),C(_(3,1,"GENERAL.VISIBLE_FOR_ADMINS_ONLY")),o(2),$(t.updateables)}}var Bi=(()=>{class e{static{this.SELECTOR="system"}static{this.REFRESH_UPDATE_STATE_INTERVAL=5e3}constructor(t,i,n,d){this.utils=t,this.service=i,this.userService=n,this.websocket=d,this.environment=f,this.spinnerId=e.SELECTOR,this.showLog=!1,this.ESTIMATED_REBOOT_TIME=600,this.restartTime=this.ESTIMATED_REBOOT_TIME,this.canSeeSystemRestart=!1,this.canSeeAdditionalUpdates=!1,this.updateables=[],fe(h=>W(this,null,function*(){let y=new le;h(()=>{y.next(),y.complete()});let R=this.userService.currentUser();this.edge=yield this.service.currentEdge(),this.edge&&(this.canSeeSystemRestart=re.isAllowedToSeeSystemRestart(R,this.edge),this.canSeeAdditionalUpdates=re.isAllowedToSeeAdditionalUpdates(this.edge),this.canSeeAdditionalUpdates&&(this.updateables=yield this.fetchUpdateables(y)))}))}executeUpdate(t){this.edge.sendRequest(this.websocket,new N({componentId:"_updateManager",payload:new ae.Request({id:t.updateable.id})})).then(i=>{t.updateState={type:"running",percentCompleted:0,logs:[]},this.subscribeUpdateState(t)})}fetchUpdateables(t){return W(this,null,function*(){return(yield this.edge.sendRequest(this.websocket,new N({componentId:"_updateManager",payload:new se.Request}))).result.updateables.map(n=>{let d={updateable:n,unsubscribe:new le};return t.subscribe(()=>{d.unsubscribe.next(),d.unsubscribe.complete()}),this.edge.sendRequest(this.websocket,new N({componentId:"_updateManager",payload:new Q.Request({id:n.id})})).then(h=>{let y=h.result;d.updateState=y.state,d.updateState.type==="running"&&this.subscribeUpdateState(d)}),d})})}subscribeUpdateState(t){pe(0,e.REFRESH_UPDATE_STATE_INTERVAL).pipe(me(t.unsubscribe)).subscribe(n=>{this.edge.isOnline&&this.edge.sendRequest(this.websocket,new N({componentId:"_updateManager",payload:new Q.Request({id:t.updateable.id})})).then(d=>{let h=d.result;t.updateState=h.state,h.state.type!=="running"&&t.unsubscribe.next()})})}static{this.\u0275fac=function(i){return new(i||e)(x(Me),x(Y),x(Oe),x(V))}}static{this.\u0275cmp=M({type:e,selectors:[["system"]],decls:10,vars:4,consts:[[1,"ion-justify-content-center"],["size","12","size-sm","8"],[3,"name"],["color","light"],["slot","start","name","cloud-download-outline","color","primary"],[3,"edge"],["lines","none"],["size","12"],["color","success",1,"ion-text-wrap"],["lines","none",1,"ion-float-right"],[3,"click"],[3,"value"],[2,"cursor","pointer",3,"keydown.enter","click"],["name","arrow-down-circle-outline"],["name","arrow-up-circle-outline"]],template:function(i,n){i&1&&(s(0,"ion-content")(1,"ion-grid")(2,"ion-row",0),m(3,At,2,0,"ion-col",1),s(4,"ion-col",1)(5,"ion-card"),u(6,"ngx-spinner",2),m(7,wt,9,5),l(),m(8,Ft,6,3),l()()(),u(9,"changelog"),l()),i&2&&(o(3),S(n.canSeeSystemRestart?3:-1),o(3),T("name",n.spinnerId),o(),S(n.edge?7:-1),o(),S(n.canSeeAdditionalUpdates&&n.updateables.length!==0?8:-1))},dependencies:[q,D,Ae,be,O,we,Z,ee,L,Ue,k,G,Be,$e,je,F,oe,Ge,Pe,P],encapsulation:2})}}return e})();export{Bi as SystemComponent};
