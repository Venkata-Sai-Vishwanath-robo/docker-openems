import{a as je}from"./chunk-QYR44BZ5.js";import{a as Qe}from"./chunk-FMKZICNI.js";import{b as U,d as b,e as We,f as z,g as $,h as Ye}from"./chunk-A6D3LFCM.js";import"./chunk-VQJOV6KK.js";import{f as qe}from"./chunk-GYAINRZU.js";import"./chunk-V6SQQYN5.js";import{$d as Me,Ab as oe,Ca as E,Da as v,E as u,Ea as p,F as h,Gd as Te,Hf as Ve,Ia as Q,Id as ke,If as De,Ja as J,Jd as be,Ka as X,La as Z,Lc as ce,Lf as Ge,Nc as de,Pc as me,Pd as Pe,Qa as c,Qc as _e,R as K,Ra as P,S as R,Sa as x,Ta as O,Tc as ue,Uf as Ue,V as a,Va as V,Wa as D,Wd as Le,Wf as ze,Xa as G,Yc as he,Yd as Fe,Zc as Ce,_a as ee,ad as xe,ba as w,bc as ae,c as q,cd as ge,da as Y,db as L,dc as re,dd as fe,dg as $e,ee as Be,fc as se,fd as Ie,fe as Ke,gc as le,gd as ye,ge as Re,hd as Ee,ia as N,jb as A,jc as pe,jd as ve,kb as T,kf as Ne,lb as te,ld as Se,m as H,ma as j,mf as Oe,mg as He,nb as ie,oa as d,oe as k,qa as m,qd as we,sa as f,t as W,ta as I,td as Ae,u as B,ua as y,va as C,wa as o,xa as s,ya as _,zb as ne}from"./chunk-UEHZAF3Y.js";import"./chunk-TCWA4BEU.js";import"./chunk-HJTVDRW6.js";import"./chunk-YJIFWFWF.js";import"./chunk-QUJFQN2Y.js";import"./chunk-P3LHHAYW.js";import"./chunk-Y7WT5TFP.js";import"./chunk-JHMH7CMQ.js";import"./chunk-WVHTM5RI.js";import"./chunk-IN6HLDFE.js";import"./chunk-GIMG75PD.js";import"./chunk-IHO4TDRD.js";import"./chunk-4KCIDQZU.js";import"./chunk-7UI6JPU6.js";import"./chunk-J5AVGG2P.js";import"./chunk-VIYDSDQU.js";import"./chunk-F46NF3P5.js";import"./chunk-SAL3DLJT.js";import"./chunk-MTHZ7MWU.js";import"./chunk-WI5MSH4N.js";import"./chunk-EOGXKGKT.js";import"./chunk-CKP3SGE2.js";import"./chunk-RY6RMDSE.js";import{g as M}from"./chunk-OQDXQ3X5.js";var F;(function(t){t.METHOD="getApps";class l extends Ne{constructor(){super(t.METHOD,{})}}t.Request=l;class e extends Oe{constructor(i,r){super(i,r),this.id=i,this.result=r}}t.Response=e})(F||(F={}));var Je=["hasKeyPopover"],Xe=t=>({opacity:t}),Ze=t=>({edgeShortName:t}),et=t=>({appCatList:t});function tt(t,l){if(t&1&&(o(0,"span"),c(1),s()),t&2){let e=p().$implicit;a(),x("(",e.permissions.canSee,")")}}function it(t,l){if(t&1&&_(0,"img",9),t&2){let e=p().$implicit;C("src",e.image,R)}}function nt(t,l){if(t&1){let e=E();o(0,"img",11),v("error",function(){u(e);let i=p(2).$implicit;return h(i.imageUrl=null)}),s()}if(t&2){let e=p(2).$implicit;C("src",e.imageUrl,R)}}function ot(t,l){if(t&1&&(o(0,"div",10)(1,"h1",12),c(2),s()()),t&2){let e=p(2).$implicit;a(2),x(" ",e.name," ")}}function at(t,l){if(t&1&&d(0,nt,1,1,"img",9)(1,ot,3,1,"div",10),t&2){let e=p().$implicit;m(e.imageUrl?0:1)}}function rt(t,l){if(t&1&&(o(0,"a"),c(1),s()),t&2){let e=l.$implicit;a(),x(" ",e.readableName," ")}}function st(t,l){if(t&1&&(o(0,"p")(1,"small"),c(2),A(3,"translate"),s(),_(4,"br"),o(5,"small"),c(6),A(7,"translate"),I(8,rt,2,1,"a",null,f),s(),_(10,"br"),o(11,"small"),c(12),A(13,"translate"),s()()),t&2){let e=p().$implicit;a(2),O("",T(3,5,"EDGE.CONFIG.APP.TECHNICAL_NAME"),": ",e.appId),a(4),x("",T(7,7,"EDGE.CONFIG.APP.CATEGORY"),": "),a(2),y(e.categorys),a(4),O("",T(13,9,"EDGE.CONFIG.APP.CARDINALITY"),": ",e.cardinality)}}function lt(t,l){if(t&1&&(o(0,"div"),_(1,"span",16),s()),t&2){let e=l.$implicit;a(),C("innerHTML",e,K)}}function pt(t,l){if(t&1&&(o(0,"div"),_(1,"span",16),s()),t&2){let e=l.$implicit;a(),C("innerHTML",e,K)}}function ct(t,l){if(t&1&&(o(0,"ion-accordion")(1,"ion-item",13)(2,"ion-label",14),c(3),A(4,"translate"),s()(),o(5,"div",15)(6,"ion-label"),I(7,lt,2,1,"div",null,f),s(),o(9,"ion-label"),I(10,pt,2,1,"div",null,f),s()()()),t&2){let e=p().$implicit;a(3),x(" ",T(4,1,"EDGE.CONFIG.APP.NOT_AVAILABLE")),a(4),y(e.status.errorCompatibleMessages),a(3),y(e.status.errorInstallableMessages)}}function dt(t,l){if(t&1){let e=E();o(0,"ion-col",5)(1,"ion-card")(2,"ion-item",6),v("click",function(){let i=u(e).$implicit,r=p(2);return h(r.onAppClicked(i))}),o(3,"ion-label",7),c(4),d(5,tt,2,1,"span"),s()(),o(6,"ion-card-content")(7,"div")(8,"div",8),v("click",function(){let i=u(e).$implicit,r=p(2);return h(r.onAppClicked(i))})("keydown.enter",function(){let i=u(e).$implicit,r=p(2);return h(r.onAppClicked(i))}),d(9,it,1,1,"img",9)(10,at,2,1),s()(),d(11,st,14,11,"p"),s(),o(12,"ion-accordion-group"),d(13,ct,12,3,"ion-accordion"),s()()()}if(t&2){let e=l.$implicit,n=p(2);a(4),x(" ",e.shortName??e.name," "),a(),m(n.edge.roleIsAtLeast("admin")&&e.permissions?5:-1),a(3),C("ngStyle",L(6,Xe,e.status.name==="INSTALLABLE"||e.instanceIds.length>0?"100%":"20%")),a(),m(e.image?9:10),a(2),m(-1),a(2),m(e.instanceIds.length===0&&e.status.name!=="INSTALLABLE"?13:-1)}}function mt(t,l){if(t&1&&I(0,dt,14,8,"ion-col",5,f),t&2){let e=l.appCatList;y(e.apps)}}function _t(t,l){if(t&1){let e=E();o(0,"ion-item",19)(1,"ion-label"),c(2),s(),o(3,"ion-checkbox",20),G("ngModelChange",function(i){let r=u(e).$implicit;return D(r.isChecked,i)||(r.isChecked=i),h(i)}),s()()}if(t&2){let e=l.$implicit;a(2),x(" ",e.val.readableName," "),a(),V("ngModel",e.isChecked)}}function ut(t,l){if(t&1){let e=E();o(0,"ion-fab",3)(1,"ion-fab-button"),_(2,"ion-icon",17),s(),o(3,"ion-fab-list",18),v("click",function(i){u(e);let r=p();return h(r.updateSelection(i))}),o(4,"ion-card"),I(5,_t,4,2,"ion-item",19,f),s()()()}if(t&2){let e=p();a(5),y(e.categories)}}function ht(t,l){if(t&1&&(o(0,"ion-card")(1,"ion-item",19),_(2,"ion-icon",21),o(3,"ion-text",22)(4,"a",23),c(5),A(6,"translate"),s()()()()),t&2){let e=p(2);a(4),C("routerLink",ee("/device/",e.edge.id,"/settings/system",e.edge.isVersionAtLeast("2021.19.1")?"":".old")),a(),P(te(6,4,"EDGE.CONFIG.APP.UPDATE_AVAILABLE",L(7,Ze,e.environment.edgeShortName)))}}function Ct(t,l){if(t&1&&(o(0,"ion-badge",29),c(1),s()),t&2){let e=p(3);a(),P(e.numberOfUnusedRegisteredKeys)}}function xt(t,l){t&1&&(o(0,"ion-content",34),c(1,"EDGE.CONFIG.APP.UNUSED_REGISTERED_KEY_AVAILABLE"),s())}function gt(t,l){if(t&1){let e=E();o(0,"ion-col",24)(1,"ion-card",25),v("click",function(){u(e);let i=p(2);return h(i.redeemKey())}),o(2,"ion-item",26),_(3,"ion-icon",27),o(4,"ion-text",28),c(5,"EDGE.CONFIG.APP.KEY.USE_KEY"),s(),d(6,Ct,2,1,"ion-badge",29),s()(),o(7,"ion-popover",30,1),N(9,xt,2,0,"ng-template"),s()(),o(10,"ion-col",24)(11,"ion-card",31),v("click",function(){u(e);let i=p(2);return h(i.registerKey())}),o(12,"ion-item",32),_(13,"ion-icon",33),o(14,"ion-text",28),c(15,"EDGE.CONFIG.APP.KEY.REGISTER_KEY"),s()()()()}if(t&2){let e=p(2);a(6),m(e.numberOfUnusedRegisteredKeys!==0?6:-1),a(),C("isOpen",e.showPopover)}}function ft(t,l){if(t&1&&(o(0,"ion-row")(1,"ion-col",4),d(2,ht,7,9,"ion-card"),s(),d(3,gt,16,2),s()),t&2){let e=p();a(),j("size-xl",e.canEnterKey?6:12),a(),m(e.isUpdateAvailable?2:-1),a(),m(e.canEnterKey?3:-1)}}function It(t,l){if(t&1){let e=E();o(0,"ion-segment-button",37),v("click",function(){u(e);let i=p(2);return h(i.updateSelection())}),o(1,"ion-text",22),c(2),s()()}if(t&2){let e=l.$implicit;a(2),x(" ",e.length," ")}}function yt(t,l){if(t&1){let e=E();o(0,"ion-row")(1,"ion-col")(2,"ion-segment",35),G("ngModelChange",function(i){u(e);let r=p();return D(r.selectedBundle,i)||(r.selectedBundle=i),h(i)}),I(3,It,3,1,"ion-segment-button",36,f),s()()()}if(t&2){let e=p();a(2),V("ngModel",e.selectedBundle),a(),y(e.key.bundles)}}function Et(t,l){if(t&1&&(o(0,"ion-row")(1,"ion-col",40)(2,"ion-card")(3,"ion-item",19)(4,"ion-label",12),c(5),s()()()(),o(6,"ion-col")(7,"ion-grid")(8,"ion-row"),_(9,"template",41),s()()()()),t&2){let e=l.$implicit;p(3);let n=Z(1);a(5),P(e.category.readableName),a(4),C("ngTemplateOutlet",n)("ngTemplateOutletContext",L(3,et,e))}}function vt(t,l){if(t&1&&(o(0,"ion-row",38)(1,"ion-col",4)(2,"ion-card")(3,"ion-item",32)(4,"ion-label",39),c(5),A(6,"translate"),s()()()()(),I(7,Et,10,5,"ion-row",null,f)),t&2){let e=p().$implicit;a(5),x(" ",T(6,1,e.name)," "),a(2),y(e.appCategories)}}function St(t,l){if(t&1&&(o(0,"div"),d(1,vt,9,3),s()),t&2){let e=l.$implicit,n=p();a(),m(!n.isEmpty(e)&&e.shouldBeShown()?1:-1)}}var Jt=(()=>{class t{static{this.SELECTOR="app-index"}static{this.MAX_APPS_IN_LIST=4}constructor(e,n,i,r,g,S){this.route=e,this.service=n,this.websocket=i,this.translate=r,this.router=g,this.modalController=S,this.spinnerId=t.SELECTOR,this.apps=[],this.installedApps={name:"EDGE.CONFIG.APP.INSTALLED",appCategories:[],shouldBeShown:()=>this.key===null},this.availableApps={name:"EDGE.CONFIG.APP.AVAILABLE",appCategories:[],shouldBeShown:()=>!0},this.incompatibleApps={name:"EDGE.CONFIG.APP.INCOMPATIBLE",appCategories:[],shouldBeShown:()=>this.edge.roleIsAtLeast(Ve.ADMIN)},this.appLists=[this.installedApps,this.availableApps,this.incompatibleApps],this.categories=[],this.environment=k,this.edge=null,this.key=null,this.selectedBundle=null,this.isUpdateAvailable=!1,this.canEnterKey=!1,this.numberOfUnusedRegisteredKeys=0,this.showPopover=!1,this.useMasterKey=!1,this.hasSeenPopover=!1,this.stopOnDestroy=new q}ngOnInit(){this.init(),this.router.events.pipe(H(e=>e instanceof ae),W(()=>this.route.url),B(this.stopOnDestroy)).subscribe(()=>{let n=this.router.currentNavigation()?.extras?.state?.appInstanceChange;n!=null&&n&&this.init()})}ngOnDestroy(){this.stopOnDestroy.next(),this.stopOnDestroy.complete()}updateSelection(e){e&&e.stopPropagation(),this.installedApps.appCategories=[],this.availableApps.appCategories=[],this.incompatibleApps.appCategories=[];let n=[];this.apps.forEach(i=>{i.categorys.forEach(r=>{if(this.selectedBundle>=0&&this.key){if(!this.key.bundles[this.selectedBundle].some(S=>i.appId===S.appId))return!1}else if(b.getByType(i.flags,b.SHOW_AFTER_KEY_REDEEM)&&k.production&&i.instanceIds.length===0)return!1;return this.categories.find(S=>S.val.name===r.name).isChecked?(n.push(i),!0):!1})}),n.forEach(i=>{i.instanceIds.length>0?(this.pushIntoCategory(i,this.installedApps),i.cardinality==="MULTIPLE"&&i.status.name!=="INCOMPATIBLE"&&this.pushIntoCategory(i,this.availableApps)):i.status.name==="INCOMPATIBLE"?this.pushIntoCategory(i,this.incompatibleApps):this.pushIntoCategory(i,this.availableApps)})}showCategories(e){return this.sum(e)>t.MAX_APPS_IN_LIST}isEmpty(e){return this.sum(e)===0}redeemKey(){return M(this,null,function*(){let e=yield this.modalController.create({component:z,componentProps:{edge:this.edge,behaviour:$.SELECT,knownApps:this.apps},cssClass:"auto-height"});return e.onDidDismiss().then(n=>{if(!n.data){this.key=null,this.useMasterKey=!1,this.updateSelection();return}if(n.data?.useMasterKey){this.selectedBundle=0,this.key={keyId:null,bundles:[this.apps.filter(i=>!b.getByType(i.flags,b.SHOW_AFTER_KEY_REDEEM)).map(i=>({id:0,appId:i.appId}))]},this.useMasterKey=!0,this.updateSelection();return}this.useMasterKey=!1,this.key=n.data.key,this.key.bundles?(this.selectedBundle=0,this.updateSelection()):this.edge.sendRequest(this.websocket,new U.Request({payload:new Qe.Request({key:this.key.keyId})})).then(i=>{let r=i.result;this.key.bundles=r.bundles,this.selectedBundle=0,this.updateSelection()})}),yield e.present()})}onAppClicked(e){this.key!=null||this.useMasterKey?this.router.navigate(["device/"+this.edge.id+"/settings/app/single/"+e.appId],{queryParams:{name:e.name},state:{app:e,appKey:this.key.keyId,useMasterKey:this.useMasterKey}}):this.router.navigate(["device/"+this.edge.id+"/settings/app/single/"+e.appId],{queryParams:{name:e.name},state:e}),this.key=null,this.useMasterKey=!1}registerKey(){return M(this,null,function*(){return yield(yield this.modalController.create({component:z,componentProps:{edge:this.edge,behaviour:$.REGISTER},cssClass:"auto-height"})).present()})}updateHasUnusedKeysPopover(){this.hasSeenPopover||this.canEnterKey&&this.numberOfUnusedRegisteredKeys!==0&&(this.hasSeenPopover=!0,this.hasKeyPopover.event={type:"willPresent",target:document.querySelector("#redeemKeyCard")},this.showPopover=!0)}pushIntoCategory(e,n){e.categorys.forEach(i=>{let r=n.appCategories.find(g=>g.category.name===i.name);r===void 0&&(r={category:i,apps:[]},n.appCategories.push(r)),r.apps.push(e)})}sum(e){return e.appCategories.reduce((n,i)=>n+i.apps.length,0)}init(){this.service.startSpinner(this.spinnerId),this.key=null,this.selectedBundle=null,this.appLists.forEach(e=>{e.appCategories=[]}),this.service.setCurrentComponent({languageKey:"EDGE.CONFIG.APP.NAME_WITH_EDGE_NAME",interpolateParams:{edgeShortName:k.edgeShortName}},this.route).then(e=>{this.edge=e,this.service.metadata.pipe(B(this.stopOnDestroy)).subscribe(i=>{this.canEnterKey=De(e,i.user),this.updateHasUnusedKeysPopover()}),e.sendRequest(this.websocket,new Ge({componentId:"_appManager",payload:new F.Request})).then(i=>{this.service.stopSpinner(this.spinnerId),this.apps=i.result.apps.map(r=>(r.imageUrl=k.links.APP_CENTER.APP_IMAGE(this.translate.getCurrentLang(),r.appId),r)),this.apps.forEach(r=>{r.categorys.forEach(g=>{this.categories.find(S=>S.val.name===g.name)||this.categories.push({val:g,isChecked:!0})})}),this.updateSelection(),e.sendRequest(this.websocket,new U.Request({payload:new We.Request({})})).then(r=>{let g=r.result;this.numberOfUnusedRegisteredKeys=g.keys.length,this.updateHasUnusedKeysPopover()}).catch(this.service.handleError)}).catch(Ye.errorToast(this.service,i=>"Error while receiving available apps: "+i));let n=new je(e,this.websocket);n.systemUpdateStateChange=i=>{i.available&&(this.isUpdateAvailable=!0)},n.start()})}static{this.\u0275fac=function(n){return new(n||t)(w(re),w(ze),w($e),w(Be),w(se),w(Me))}}static{this.\u0275cmp=Y({type:t,selectors:[["app-index"]],viewQuery:function(n,i){if(n&1&&Q(Je,5),n&2){let r;J(r=X())&&(i.hasKeyPopover=r.first)}},decls:12,vars:4,consts:[["appsList",""],["hasKeyPopover",""],[3,"name"],["vertical","top","horizontal","end","slot","fixed"],["size","12"],["size","6","size-xs","6","size-sm","4","size-lg","3","size-xl","2"],["lines","full","color","primary",2,"cursor","pointer",3,"click"],[1,"ion-no-margin",2,"white-space","initial"],[2,"display","flex","align-items","center","justify-content","center","cursor","pointer",3,"click","keydown.enter","ngStyle"],[3,"src"],[2,"max-width","100%"],[3,"error","src"],[2,"text-align","center","white-space","initial"],["slot","header","color","light"],[2,"white-space","initial","text-align","center"],["slot","content",1,"ion-padding"],[3,"innerHTML"],["name","filter"],["side","start",3,"click"],["lines","full","color","light"],[2,"margin-left","15px",3,"ngModelChange","ngModel"],["slot","start","size","large","name","information-outline"],["text-nowrap",""],["text-nowrap","","translate","",3,"routerLink"],["size","12","size-md","6","size-xl","3"],["id","redeemKeyCard",2,"cursor","pointer",3,"click"],["lines","full","color","primary","id","bottom-start"],["slot","start","name","bag-add-outline"],["translate",""],["slot","end","color","dark"],["side","bottom","alignment","center",3,"isOpen"],[2,"cursor","pointer",3,"click"],["lines","full","color","primary"],["slot","start","name","key-outline"],["text-nowrap","","translate","",1,"ion-padding"],[3,"ngModelChange","ngModel"],["value","{","{i}}",""],["value","{","{i}}","",3,"click"],[2,"position","-webkit-sticky","position","sticky","top","0px","z-index","100"],[2,"text-align","center"],["size","12","size-xl","2",2,"padding-top","18px"],[3,"ngTemplateOutlet","ngTemplateOutletContext"]],template:function(n,i){n&1&&(N(0,mt,2,0,"ng-template",null,0,ie),o(2,"ion-content"),_(3,"ngx-spinner",2),d(4,ut,7,0,"ion-fab",3),o(5,"ion-grid"),d(6,ft,4,3,"ion-row"),d(7,yt,5,1,"ion-row"),o(8,"ion-row")(9,"ion-col",4),I(10,St,2,1,"div",null,f),s()()()()),n&2&&(a(3),C("name",i.spinnerId),a(),m(-1),a(2),m(6),a(),m(i.key&&i.key.bundles?7:-1),a(3),y(i.appLists))},dependencies:[He,oe,ne,me,_e,ue,he,Ce,xe,ge,fe,Ie,ye,Ee,ve,Se,we,Ae,Te,ke,be,Pe,Fe,ce,de,Le,Ke,qe,Ue,pe,le,Re],encapsulation:2})}}return t})();export{Jt as IndexComponent};
